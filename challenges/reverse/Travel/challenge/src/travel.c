// gcc -m32 -o travel.unpacked travel.c && ./upx-5.0.1-amd64_linux/upx -f travel.unpacked -o travel && cp travel ../../assets
#include <stdio.h>
#include <string.h>
#include <stdint.h>
#include <sys/mman.h>
#include <unistd.h>
#include <sys/ptrace.h>
#include <stdlib.h>

// XOR decryption key
#define XOR_KEY 0xAA

unsigned char code[] = {
    0x84, 0xAB, 0xAA, 0xAA, 0xAA, 0x44, 0xEA, 0xAA, 0xAA, 0xAA, 0xC4, 0xB4, 0xAA, 0xAA, 0x6B, 0x04,
    0xA7, 0xAA, 0xAA, 0xAA, 0xD9, 0x8A, 0x84, 0x6A, 0xAA, 0xAA, 0xAA, 0x44, 0xAA, 0xAA, 0xAA, 0xAA,
    0xC4, 0x52, 0xAA, 0xAA, 0x6B, 0x04, 0x63, 0xAA, 0xAA, 0xAA, 0xD9, 0x8A, 0x05, 0x52, 0xAA, 0xAA,
    0x6B, 0x45, 0x85, 0xAA, 0xAA, 0x6B, 0xC4, 0x63, 0xAA, 0xAA, 0xAA, 0xF8, 0x56, 0x03, 0xF7, 0xAC,
    0x84, 0xAB, 0xAA, 0xAA, 0xAA, 0x44, 0xEA, 0xAA, 0xAA, 0xAA, 0xC4, 0x81, 0xAA, 0xAA, 0x6B, 0x04,
    0xE8, 0xAA, 0xAA, 0xAA, 0xD9, 0x8A, 0x50, 0x2F, 0x84, 0xAB, 0xAA, 0xAA, 0xAA, 0x44, 0xEA, 0xAA,
    0xAA, 0xAA, 0xC4, 0xC7, 0xAA, 0xAA, 0x6B, 0x04, 0x6B, 0xAA, 0xAA, 0xAA, 0xD9, 0x8A, 0x84, 0xEA,
    0xAA, 0xAA, 0xAA, 0xE6, 0x5C, 0xD9, 0x8A, 0xAA, 0x7F, 0xB0, 0xF2, 0xB7, 0xA2, 0xB3, 0x71, 0xA2,
    0xF4, 0x71, 0xF7, 0xA2, 0xB3, 0x71, 0xA2, 0x77, 0xB0, 0xF3, 0x31, 0xA2, 0xF4, 0x71, 0xF7, 0x63,
    0x36, 0xF3, 0xA2, 0xB7, 0x36, 0xF2, 0x37, 0xF3, 0xB1, 0xB1, 0xF0, 0x31, 0x73, 0xA2, 0xB7, 0x36,
    0xF2, 0x37, 0xF3, 0xB1, 0xB1, 0xF0, 0x31, 0x73, 0xA2, 0x65, 0xA2, 0xAA, 0x7A, 0x71, 0x36, 0x36,
    0xF3, 0x72, 0xB7, 0xE2, 0xAA, 0x7F, 0x36, 0x71, 0x31, 0x73, 0xE2, 0xAA, 0x73, 0xB0, 0x72, 0xB7,
    0x33, 0x74, 0xA6, 0x33, 0x7D, 0x72, 0xA6, 0xF7, 0x36, 0xE7, 0x66, 0x7D, 0xFC, 0xA6, 0xF7, 0x7D,
    0xBE, 0xA7, 0x72, 0x70, 0x7D, 0xBE, 0xA7, 0x72, 0x70, 0xE2, 0x7D, 0xA6, 0x33, 0xA6, 0x33, 0xA6,
    0x33, 0xF5, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA,
    0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA,
    0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA,
    0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA,
    0xAA, 0xAA, 0xAA
};
size_t code_len = sizeof(code);

void setup(){
    setvbuf(stdout, NULL, _IONBF, 0);
    setvbuf(stdin, NULL, _IONBF, 0);

    if (ptrace(PTRACE_TRACEME, 0, NULL, 0) == -1)   exit(1);
}

void decrypt_code(){
    // Decrypt shellcode
    for (size_t i = 0; i < sizeof(code); i++){
        // ROL(code[i] ^ XOR_KEY, 2)
        code[i] = code[i] >> 6 | code[i] << 2;
        code[i] ^= XOR_KEY;
    }
}

int main() {
    setup();

    void *mem = mmap(
        (void *) 0x7000000,
        code_len,
        PROT_READ | PROT_WRITE | PROT_EXEC,
        MAP_PRIVATE | MAP_ANONYMOUS | MAP_FIXED,
        -1,
        0
    );

    if (mem == MAP_FAILED) {
        perror("mmap failed");
        return 1;
    }

    decrypt_code();

    memcpy(mem, code, sizeof(code));

    // Execute shellcode 
    goto *mem;
}
